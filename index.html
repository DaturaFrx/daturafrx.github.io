<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Awesome Stuff - Blog Only</title>
  <link rel="stylesheet" href="css/style.css" />
  <!-- Marked.js for Markdown conversion -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <style>
    /* Basic styling for the blog tab and content */
    .tabs {
      display: flex;
      gap: 1rem;
      padding: 1rem;
      background: #f0f0f0;
    }
    .tab-button {
      padding: 0.5rem 1rem;
      cursor: pointer;
      border: none;
      background: #ddd;
    }
    .tab-button.active {
      background: #bbb;
      font-weight: bold;
    }
    .tab-content {
      padding: 1rem;
    }
    .blog-post {
      margin-bottom: 2rem;
      border-bottom: 1px solid #ccc;
      padding-bottom: 1rem;
    }
    .post-date {
      color: #888;
      font-size: 0.9em;
    }
    .refresh-btn {
      margin: 0.5rem 0;
      padding: 0.4rem 0.8rem;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <!-- Navigation (only Blog tab is needed) -->
  <nav class="tabs">
    <button id="blogTabButton" class="tab-button active">Blog</button>
  </nav>

  <!-- Blog Tab Content -->
  <div id="blogTab" class="tab-content">
    <h1>Blog</h1>
    <!-- Refresh button for blog posts -->
    <button id="refreshBlogBtn" class="refresh-btn">Refresh Blog</button>
    <div id="blogContainer"></div>
  </div>

  <script>
    // Configuration: GitHub repository details and API URL for blog posts.
    const repoOwner = 'DaturaFrx';
    const repoName = 'daturafrx.github.io';
    // Blog posts are stored in the "docs" directory.
    const blogApiUrl = `https://api.github.com/repos/${repoOwner}/${repoName}/contents/docs`;

    // Function to append a timestamp to URLs for cache busting.
    function bustCache(url) {
      return url + "?t=" + new Date().getTime();
    }

    // Refresh button element for the blog.
    const refreshBlogBtn = document.getElementById('refreshBlogBtn');

    // Load blog posts from the docs directory.
    function loadBlogPosts() {
      fetch(bustCache(blogApiUrl))
        .then(response => response.json())
        .then(files => {
          // Array to store promises for each blog post.
          const postPromises = [];
          files.forEach(file => {
            const extension = file.name.split('.').pop().toLowerCase();
            // Only process Markdown (.md) and text (.txt) files.
            if (extension === 'md' || extension === 'txt') {
              // Fetch each file with cache busting.
              const promise = fetch(bustCache(file.download_url))
                .then(response => response.text())
                .then(text => {
                  // Regex to match: date$$ddmmyyyy or date$$ddmmyyyy-X (where X is the order number)
                  let regex = /date\$\$(\d{2})(\d{2})(\d{4})(?:-(\d+))?/i;
                  let match = text.match(regex);
                  let postDate = null;
                  let orderNumber = 0;
                  if (match) {
                    // Extract day, month, year, and order number (if present)
                    const dd = match[1],
                          mm = match[2],
                          yyyy = match[3];
                    orderNumber = match[4] ? parseInt(match[4], 10) : 0;
                    // Construct a date object (format: yyyy-mm-dd)
                    postDate = new Date(`${yyyy}-${mm}-${dd}`);
                    // Remove the date string from the post content.
                    text = text.replace(match[0], '').trim();
                  } else {
                    // If no date is found, assign a default old date.
                    postDate = new Date(0);
                  }
                  return {
                    fileName: file.name,
                    extension: extension,
                    content: text,
                    postDate: postDate,
                    orderNumber: orderNumber
                  };
                });
              postPromises.push(promise);
            }
          });
          return Promise.all(postPromises);
        })
        .then(posts => {
          // Sort posts: first by date descending (newest first), then by order number ascending.
          posts.sort((a, b) => {
            if (b.postDate - a.postDate !== 0) {
              return b.postDate - a.postDate;
            } else {
              return a.orderNumber - b.orderNumber;
            }
          });
          // Clear the blog container.
          const blogContainer = document.getElementById('blogContainer');
          blogContainer.innerHTML = "";
          // Append each sorted post.
          posts.forEach(post => {
            const blogPost = document.createElement('div');
            blogPost.classList.add('blog-post');
            // Create and append title (filename without extension).
            const title = document.createElement('h2');
            title.innerText = post.fileName.replace(/\.[^/.]+$/, "");
            blogPost.appendChild(title);
            // Display the date if available.
            if (post.postDate.getTime() !== 0) {
              // Format date as dd/mm/yyyy.
              const dd = String(post.postDate.getDate()).padStart(2, '0');
              const mm = String(post.postDate.getMonth() + 1).padStart(2, '0');
              const yyyy = post.postDate.getFullYear();
              const dateElem = document.createElement('p');
              dateElem.classList.add('post-date');
              dateElem.innerText = `Posted on: ${dd}/${mm}/${yyyy} - Order: ${post.orderNumber}`;
              blogPost.appendChild(dateElem);
            }
            // Create the content container and convert Markdown if needed.
            const contentDiv = document.createElement('div');
            if (post.extension === 'md') {
              contentDiv.innerHTML = marked(post.content);
            } else {
              contentDiv.innerText = post.content;
            }
            blogPost.appendChild(contentDiv);
            blogContainer.appendChild(blogPost);
          });
        })
        .catch(error => {
          console.error("Error loading blog posts:", error);
          document.getElementById("blogContainer").innerText = "Error loading blog posts.";
        });
    }

    // Refresh button event listener for the blog.
    refreshBlogBtn.addEventListener('click', () => {
      document.getElementById('blogContainer').innerHTML = "";
      loadBlogPosts();
    });

    // Load blog posts on initial page load.
    window.addEventListener("load", () => {
      loadBlogPosts();
    });
  </script>
</body>
</html>
