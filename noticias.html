<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Noticias de México</title>
  <style>
    :root {
      --primary: #000;
      --bg: #fff;
      --border: #ddd;
      --shadow: rgba(0, 0, 0, 0.1);
      --success: #0a0;
      --warning: #fa0;
      --error: #f00;
    }

    * {
      box-sizing: border-box;
    }

    html, body {
      height: 100%;
      margin: 0;
      background: var(--bg);
      color: var(--primary);
      font-family: "Courier New", monospace;
      font-size: 14px;
    }

    .header {
      background: var(--bg);
      border-bottom: 2px solid var(--primary);
      padding: 16px 24px;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .header h1 {
      margin: 0;
      font-size: 20px;
      font-weight: bold;
      text-align: center;
    }

    .status-bar {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      font-size: 11px;
      margin-top: 8px;
      color: #666;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #666;
    }

    .status-dot.loading {
      background: var(--warning);
      animation: pulse 1s infinite;
    }

    .status-dot.loaded {
      background: var(--success);
    }

    .status-dot.error {
      background: var(--error);
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 24px;
    }

    .section-divider {
      margin: 48px 0 32px 0;
      padding: 12px 16px;
      border: 1px solid var(--border);
      border-left: 3px solid var(--error);
      background: #f8f8f8;
    }

    .section-divider h2 {
      margin: 0;
      font-size: 14px;
      font-weight: bold;
      color: #666;
    }

    .section-divider p {
      margin: 4px 0 0 0;
      font-size: 11px;
      color: #999;
    }

    .feed-section {
      margin-bottom: 40px;
      border-left: 3px solid var(--primary);
      padding-left: 16px;
      opacity: 0;
      animation: fadeIn 0.3s ease forwards;
    }

    @keyframes fadeIn {
      to { opacity: 1; }
    }

    .feed-section.error {
      border-left-color: var(--error);
      opacity: 0.6;
    }

    .feed-section.loading {
      border-left-color: var(--warning);
    }

    .feed-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 16px;
    }

    .feed-title {
      font-size: 16px;
      font-weight: bold;
      margin: 0;
    }

    .feed-status {
      font-size: 10px;
      padding: 2px 6px;
      border: 1px solid var(--border);
      background: #f8f8f8;
    }

    .feed-status.loading {
      color: var(--warning);
      border-color: var(--warning);
    }

    .feed-status.error {
      color: var(--error);
      border-color: var(--error);
    }

    .feed-items {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .feed-item {
      border-bottom: 1px solid var(--border);
      padding-bottom: 12px;
      transition: all 0.2s ease;
    }

    .feed-item:last-child {
      border-bottom: none;
    }

    .feed-item:hover {
      padding-left: 8px;
    }

    .feed-item a {
      color: var(--primary);
      text-decoration: none;
      display: block;
      line-height: 1.5;
    }

    .feed-item a:hover {
      color: #0066cc;
    }

    .feed-item-meta {
      font-size: 10px;
      color: #999;
      margin-top: 4px;
    }

    .error-message {
      color: var(--error);
      font-size: 11px;
      margin-top: 8px;
      font-style: italic;
    }

    .loading-skeleton {
      height: 20px;
      background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
      background-size: 200% 100%;
      animation: loading 1.5s infinite;
      margin-bottom: 12px;
    }

    @keyframes loading {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }

    .retry-btn {
      background: var(--primary);
      color: var(--bg);
      border: none;
      padding: 6px 12px;
      font-size: 11px;
      font-family: inherit;
      cursor: pointer;
      margin-top: 8px;
    }

    .retry-btn:hover {
      opacity: 0.8;
    }

    @media (max-width: 768px) {
      .container {
        padding: 16px;
      }

      .header {
        padding: 12px 16px;
      }

      .header h1 {
        font-size: 16px;
      }
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>Noticias de México</h1>
    <div class="status-bar">
      <span class="status-dot loading" id="statusDot"></span>
      <span id="statusText">Cargando feeds...</span>
    </div>
  </div>

  <div class="container">
    <div id="feedsWorking"></div>
    <div id="dividerContainer"></div>
    <div id="feedsFailed"></div>
  </div>

  <script>
    const feeds = {
      "Mexico News Daily": "https://mexiconewsdaily.com/feed/",
      "Excélsior": "https://www.excelsior.com.mx/rss.xml",
      "Reforma": "https://www.reforma.com/rss/portada.xml",
      "Vanguardia": "https://vanguardia.com.mx/rss.xml",
      "El Siglo de Torreón": "https://www.elsiglodetorreon.com.mx/index.xml",
      "SinEmbargo": "https://www.sinembargo.mx/feed/",
      "El Norte": "https://www.elnorte.com/rss/portada.xml",
      "Diario de Yucatán": "https://www.yucatan.com.mx/feed",
      "El Informador": "https://www.informador.mx/rss/mexico.xml",
      "24 Horas": "https://24-horas.mx/feed/",
      "La Jornada": "https://www.jornada.com.mx/",
      "Eje Central": "https://www.ejecentral.com.mx/",
      "La Silla Rota": "https://lasillarota.com/",
      "Gobierno de México - Presidencia (press page)": "https://www.gob.mx/presidencia"
    };

    let loadedCount = 0;
    let errorCount = 0;
    const totalFeeds = Object.keys(feeds).length;
    let dividerAdded = false;

    function updateStatus() {
      const statusDot = document.getElementById('statusDot');
      const statusText = document.getElementById('statusText');
      
      if (loadedCount + errorCount === totalFeeds) {
        if (errorCount === totalFeeds) {
          statusDot.className = 'status-dot error';
          statusText.textContent = 'Error: No se pudieron cargar los feeds';
        } else if (errorCount > 0) {
          statusDot.className = 'status-dot loaded';
          statusText.textContent = `Cargado: ${loadedCount}/${totalFeeds} feeds (${errorCount} errores)`;
        } else {
          statusDot.className = 'status-dot loaded';
          statusText.textContent = `Cargado: ${totalFeeds} feeds`;
        }
      } else {
        statusText.textContent = `Cargando feeds... ${loadedCount + errorCount}/${totalFeeds}`;
      }
    }

    function addDivider() {
      if (dividerAdded || errorCount === 0) return;
      
      const dividerContainer = document.getElementById('dividerContainer');
      dividerContainer.innerHTML = `
        <div class="section-divider">
          <h2>Feeds con problemas</h2>
          <p>Los siguientes feeds no pudieron cargarse correctamente</p>
        </div>
      `;
      dividerAdded = true;
    }

    function createLoadingSkeleton(container) {
      for (let i = 0; i < 3; i++) {
        const skeleton = document.createElement('div');
        skeleton.className = 'loading-skeleton';
        skeleton.style.width = `${60 + Math.random() * 30}%`;
        container.appendChild(skeleton);
      }
    }

    function cleanText(text) {
      if (!text) return '';
      // Remove CDATA wrappers
      text = text.replace(/<!\[CDATA\[(.*?)\]\]>/g, '$1');
      // Decode HTML entities
      const textarea = document.createElement('textarea');
      textarea.innerHTML = text;
      return textarea.value.trim();
    }

    function getElementText(element, selectors) {
      for (const selector of selectors) {
        const el = element.querySelector(selector);
        if (el) {
          return cleanText(el.textContent);
        }
      }
      return null;
    }

    function parseItems(xml) {
      const items = [];
      
      // Try RSS format
      const rssItems = xml.querySelectorAll('item');
      rssItems.forEach(item => {
        const title = getElementText(item, ['title']);
        const link = getElementText(item, ['link', 'guid']);
        const pubDate = getElementText(item, ['pubDate', 'dc\\:date', 'date']);
        
        if (title && link) {
          items.push({ title, link, pubDate });
        }
      });
      
      // Try Atom format if no RSS items found
      if (items.length === 0) {
        const atomEntries = xml.querySelectorAll('entry');
        atomEntries.forEach(entry => {
          const title = getElementText(entry, ['title']);
          const linkEl = entry.querySelector('link[rel="alternate"], link');
          const link = linkEl ? linkEl.getAttribute('href') : null;
          const pubDate = getElementText(entry, ['published', 'updated']);
          
          if (title && link) {
            items.push({ title, link, pubDate });
          }
        });
      }
      
      return items;
    }

    async function loadFeed(name, url) {
      const section = document.createElement('section');
      section.className = 'feed-section loading';
      section.id = `feed-${name.replace(/\s+/g, '-').toLowerCase()}`;
      
      const header = document.createElement('div');
      header.className = 'feed-header';
      header.innerHTML = `
        <h2 class="feed-title">${name}</h2>
        <span class="feed-status loading">Cargando...</span>
      `;
      section.appendChild(header);
      
      const itemsContainer = document.createElement('div');
      itemsContainer.className = 'feed-items';
      createLoadingSkeleton(itemsContainer);
      section.appendChild(itemsContainer);
      
      // Add to working container initially
      document.getElementById('feedsWorking').appendChild(section);

      try {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 15000);
        
        const response = await fetch(`https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`, {
          signal: controller.signal
        });
        
        clearTimeout(timeoutId);
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }
        
        let text = await response.text();
        
        if (!text || text.trim().length === 0) {
          throw new Error('Feed vacío');
        }
        
        // Clean up malformed XML
        text = text.replace(/&(?!(?:amp|lt|gt|quot|apos|#\d+|#x[\da-fA-F]+);)/g, '&amp;');
        
        const parser = new DOMParser();
        const xml = parser.parseFromString(text, "text/xml");
        
        const parserError = xml.querySelector('parsererror');
        if (parserError) {
          // Try as HTML parser as fallback
          const htmlDoc = new DOMParser().parseFromString(text, "text/html");
          const items = parseItems(htmlDoc);
          
          if (items.length === 0) {
            throw new Error('Error al parsear XML/HTML');
          }
          
          displayItems(items, itemsContainer, header, section);
        } else {
          const items = parseItems(xml);
          
          if (items.length === 0) {
            throw new Error('No se encontraron artículos');
          }
          
          displayItems(items, itemsContainer, header, section);
        }
        
        loadedCount++;
        
      } catch (err) {
        console.error(`Error loading ${name}:`, err);
        
        // Move to failed section
        addDivider();
        document.getElementById('feedsFailed').appendChild(section);
        
        section.className = 'feed-section error';
        
        const statusSpan = header.querySelector('.feed-status');
        statusSpan.className = 'feed-status error';
        statusSpan.textContent = 'Error';
        
        const errorMsg = err.name === 'AbortError' ? 'Tiempo de espera agotado' : (err.message || 'Error desconocido');
        
        itemsContainer.innerHTML = `
          <div class="error-message">
            No se pudo cargar este feed. ${errorMsg}
          </div>
          <button class="retry-btn" onclick="retryFeed('${name.replace(/'/g, "\\'")}', '${url.replace(/'/g, "\\'")}')">
            Reintentar
          </button>
        `;
        
        errorCount++;
      } finally {
        updateStatus();
      }
    }

    function displayItems(items, itemsContainer, header, section) {
      itemsContainer.innerHTML = '';
      section.className = 'feed-section';
      
      const displayCount = Math.min(items.length, 5);
      
      for (let i = 0; i < displayCount; i++) {
        const { title, link, pubDate } = items[i];
        
        const div = document.createElement("div");
        div.className = "feed-item";
        
        let dateStr = '';
        if (pubDate) {
          try {
            const date = new Date(pubDate);
            if (!isNaN(date.getTime())) {
              dateStr = `<div class="feed-item-meta">${date.toLocaleString('es-MX', { 
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
              })}</div>`;
            }
          } catch (e) {
            // Ignore date errors
          }
        }
        
        div.innerHTML = `
          <a href="${link}" target="_blank" rel="noopener noreferrer">${title.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</a>
          ${dateStr}
        `;
        itemsContainer.appendChild(div);
      }
      
      header.querySelector('.feed-status').remove();
    }

    window.retryFeed = async function(name, url) {
      const section = document.getElementById(`feed-${name.replace(/\s+/g, '-').toLowerCase()}`);
      if (section) {
        section.remove();
      }
      
      if (errorCount > 0) errorCount--;
      
      updateStatus();
      await loadFeed(name, url);
    };

    window.onload = () => {
      for (const [name, url] of Object.entries(feeds)) {
        loadFeed(name, url);
      }
    };
  </script>
</body>
</html>
