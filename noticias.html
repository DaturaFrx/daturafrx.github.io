<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Agregador de Noticias RSS de México</title>
<style>
:root{
  --primary:#000;
  --bg:#fff;
  --border:#ddd;
  --shadow:rgba(0,0,0,.08);
  --success:#0a0;
  --warning:#fa0;
  --error:#f00;
  --muted:#666;
  --muted-2:#999;
  --card-bg:#f8f8f8;
  --radius:12px;
  --mono: "Courier New", monospace;
  --toggle-track:#e6e6e6;
  --toggle-thumb:#111;
}

[data-theme="dark"]{
  --primary:#fff;
  --bg:#0f1113;
  --border:#2b2b2b;
  --shadow:rgba(255,255,255,.03);
  --success:#6fe36f;
  --warning:#ffb84d;
  --error:#ff6b6b;
  --muted:#bdbdbd;
  --muted-2:#9aa0a6;
  --card-bg:#141617;
  --toggle-track:#2b2b2b;
  --toggle-thumb:#fff;
}

*{box-sizing:border-box}
html,body{height:100%;margin:0;background:var(--bg);color:var(--primary);font-family:var(--mono);font-size:14px;-webkit-font-smoothing:antialiased}
.header{background:var(--bg);border-bottom:2px solid var(--primary);position:sticky;top:0;z-index:120;padding:14px 18px}
.header-top{display:flex;align-items:center;gap:12px;justify-content:space-between;flex-wrap:wrap}
h1{margin:0;font-size:18px;font-weight:700;text-align:center;flex:1}
.controls{display:flex;align-items:center;gap:10px;min-width:180px;justify-content:flex-end}
.clock{font-size:13px;color:var(--muted);white-space:nowrap}
.theme-toggle{width:52px;height:30px;border-radius:999px;background:var(--toggle-track);position:relative;cursor:pointer;border:1px solid var(--border);display:inline-flex;align-items:center;padding:4px}
.theme-toggle:focus{outline:3px solid rgba(100,150,255,.12)}
.theme-toggle-thumb{width:22px;height:22px;border-radius:50%;background:var(--toggle-thumb);transition:transform .28s cubic-bezier(.2,.9,.2,1);box-shadow:0 4px 10px var(--shadow)}
[data-theme="dark"] .theme-toggle-thumb{transform:translateX(22px)}
.status-bar{display:flex;align-items:center;gap:10px;justify-content:center;font-size:12px;margin-top:10px;color:var(--muted)}
.status-dot{width:9px;height:9px;border-radius:50%;background:var(--muted)}
.status-dot.loading{background:var(--warning);animation:pulse 1s infinite}
.status-dot.loaded{background:var(--success)}
.status-dot.error{background:var(--error)}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}

.container{max-width:1100px;margin:18px auto;padding:18px}
.section-divider{margin:36px 0;padding:12px 14px;border:1px solid var(--border);border-left:4px solid var(--error);background:var(--card-bg);border-radius:8px}
.section-divider h2{margin:0;font-size:14px;color:var(--muted)}
.section-divider p{margin:6px 0 0 0;font-size:12px;color:var(--muted-2)}

.feed-section{margin-bottom:30px;border-left:4px solid var(--primary);padding-left:14px;background:transparent;padding-top:12px;padding-bottom:12px;border-radius:8px;box-shadow:0 1px 0 rgba(0,0,0,.02)}
.feed-section.error{border-left-color:var(--error);opacity:.9}
.feed-section.loading{border-left-color:var(--warning)}
.feed-header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:12px}
.feed-title{margin:0;font-size:16px;font-weight:700}
.feed-status{font-size:11px;padding:4px 8px;border:1px solid var(--border);background:var(--card-bg);border-radius:6px;color:var(--muted)}
.feed-status.loading{color:var(--warning);border-color:var(--warning)}
.feed-status.error{color:var(--error);border-color:var(--error)}

.feed-items{display:flex;flex-direction:column;gap:10px}
.feed-item{padding:6px 0;border-bottom:1px dashed var(--border)}
.feed-item:last-child{border-bottom:none}
.feed-item a{color:var(--primary);text-decoration:none;display:block;line-height:1.45}
.feed-item a:hover{text-decoration:underline}
.feed-item-meta{font-size:11px;color:var(--muted-2);margin-top:4px}

.error-message{color:var(--error);font-size:12px;margin-top:8px;font-style:italic}
.loading-skeleton{height:14px;background:linear-gradient(90deg,#f0f0f0 25%,#e9e9e9 50%,#f0f0f0 75%);background-size:200% 100%;animation:loading 1.2s infinite;border-radius:6px}
@keyframes loading{0%{background-position:200% 0}100%{background-position:-200% 0}}

.retry-btn{background:transparent;border:1px solid var(--primary);padding:6px 10px;border-radius:8px;font-family:inherit;cursor:pointer}
.retry-btn:hover{opacity:.9}

@media (max-width:640px){
  .header{padding:12px}
  h1{font-size:16px}
  .controls{min-width:0;justify-content:flex-end}
  .theme-toggle{width:46px;height:26px;padding:3px}
  .theme-toggle-thumb{width:20px;height:20px}
  [data-theme="dark"] .theme-toggle-thumb{transform:translateX(20px)}
  .container{padding:12px}
}
</style>
</head>
<body>
  <div class="header" role="banner">
    <div class="header-top">
      <h1>Noticias de México (RSS)</h1>
      <div class="controls" role="navigation" aria-label="Controles">
        <div id="themeToggle" class="theme-toggle" role="button" tabindex="0" aria-pressed="false" aria-label="Cambiar tema" title="Cambiar tema">
          <div class="theme-toggle-thumb" aria-hidden="true"></div>
        </div>
        <div id="clockCDMX" class="clock" aria-live="polite">--:--:--</div>
      </div>
    </div>
    <div class="status-bar" role="status" aria-live="polite">
      <span id="statusDot" class="status-dot loading" aria-hidden="true"></span>
      <span id="statusText">Cargando feeds...</span>
    </div>
  </div>

  <main class="container" role="main">
    <div id="feedsContainer" aria-live="polite"></div>
    <div id="dividerContainer"></div>
    <div id="feedsFailed" aria-live="polite"></div>
  </main>

<script>
/* Configuración de feeds */
const feeds = {
  "Mi RSS": "https://daturafrx.github.io/feed.xml",
  "La Jornada - Política": "https://www.jornada.com.mx/rss/politica.xml",
  "Mexico News Daily": "https://mexiconewsdaily.com/feed/",
  "Excélsior": "https://www.excelsior.com.mx/rss.xml",
  "Reforma": "https://www.reforma.com/rss/portada.xml",
  "Vanguardia": "https://vanguardia.com.mx/rss.xml",
  "El Siglo de Torreón": "https://www.elsiglodetorreon.com.mx/index.xml",
  "SinEmbargo": "https://www.sinembargo.mx/feed/",
  "El Norte": "https://www.elnorte.com/rss/portada.xml",
  "Diario de Yucatán": "https://www.yucatan.com.mx/feed",
  "El Informador": "https://www.informador.mx/rss/mexico.xml",
  "24 Horas": "https://24-horas.mx/feed/"
};

let loadedCount = 0;
let errorCount = 0;
const totalFeeds = Object.keys(feeds).length;
let dividerAdded = false;

/* Reloj CDMX */
function updateClock(){
  try{
    const options = { timeZone: 'America/Mexico_City', hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false };
    const time = new Date().toLocaleTimeString('es-MX', options);
    document.getElementById('clockCDMX').textContent = time;
  }catch(e){
    document.getElementById('clockCDMX').textContent = '--:--:--';
  }
}
setInterval(updateClock,1000);
updateClock();

/* Helpers para cookies (solo tema) */
function setCookie(name,value,days){
  const maxAge = days ? days*24*60*60 : 31536000;
  document.cookie = `${encodeURIComponent(name)}=${encodeURIComponent(value)};path=/;max-age=${maxAge};SameSite=Lax`;
}
function getCookie(name){
  const m = document.cookie.match('(?:^|; )' + name.replace(/([\.$?*|{}\(\)\[\]\\\/\+^])/g,'\\$1') + '=([^;]*)');
  return m ? decodeURIComponent(m[1]) : null;
}

/* Tema: usa cookie si existe, si no usa prefers-color-scheme */
function applyTheme(theme){
  document.documentElement.setAttribute('data-theme', theme);
  const toggle = document.getElementById('themeToggle');
  const pressed = theme === 'dark';
  toggle.setAttribute('aria-pressed', String(pressed));
  // guardar en cookie
  setCookie('theme', theme, 365);
}
function getInitialTheme(){
  const cookie = getCookie('theme');
  if(cookie === 'dark' || cookie === 'light') return cookie;
  const prefers = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
  return prefers ? 'dark' : 'light';
}
const initialTheme = getInitialTheme();
applyTheme(initialTheme);

/* Toggle: click y teclado */
const toggleEl = document.getElementById('themeToggle');
toggleEl.addEventListener('click', () => {
  const cur = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'light';
  const next = cur === 'dark' ? 'light' : 'dark';
  applyTheme(next);
});
toggleEl.addEventListener('keydown', (ev) => {
  if(ev.key === 'Enter' || ev.key === ' '){
    ev.preventDefault();
    toggleEl.click();
  }
});

/* Estado de carga */
function updateStatus(){
  const statusDot = document.getElementById('statusDot');
  const statusText = document.getElementById('statusText');
  const done = loadedCount + errorCount;
  if(done === totalFeeds){
    if(errorCount === totalFeeds){
      statusDot.className = 'status-dot error';
      statusText.textContent = 'Error: no se pudieron cargar los feeds';
    }else if(errorCount > 0){
      statusDot.className = 'status-dot loaded';
      statusText.textContent = `Cargado: ${loadedCount}/${totalFeeds} feeds (${errorCount} errores)`;
    }else{
      statusDot.className = 'status-dot loaded';
      statusText.textContent = `Cargado: ${totalFeeds} feeds`;
    }
  }else{
    statusDot.className = 'status-dot loading';
    statusText.textContent = `Cargando feeds... ${done}/${totalFeeds}`;
  }
}

/* Divider para feeds problemáticos */
function addDivider(){
  if(dividerAdded || errorCount === 0) return;
  const container = document.getElementById('dividerContainer');
  container.innerHTML = `
    <div class="section-divider" role="region" aria-label="Feeds con problemas">
      <h2>Feeds con problemas</h2>
      <p>Los siguientes feeds no pudieron cargarse correctamente</p>
    </div>
  `;
  dividerAdded = true;
}

/* Skeletons */
function createLoadingSkeleton(container){
  for(let i=0;i<3;i++){
    const s = document.createElement('div');
    s.className = 'loading-skeleton';
    s.style.width = `${60 + Math.random()*30}%`;
    container.appendChild(s);
  }
}

/* Limpieza y extracción */
function decodeHTML(html){
  const t = document.createElement('textarea');
  t.innerHTML = html;
  return t.value;
}
function cleanText(text){
  if(!text) return '';
  text = text.replace(/<!\[CDATA\[([\s\S]*?)\]\]>/g,'$1');
  for(let i=0;i<3;i++){
    const d = decodeHTML(text);
    if(d === text) break;
    text = d;
  }
  text = text.replace(/<[^>]+>/g,' ');
  text = text.replace(/\s+/g,' ').trim();
  return text;
}
function getText(element){
  if(!element) return '';
  const html = element.innerHTML || '';
  const cdata = html.match(/<!\[CDATA\[([\s\S]*?)\]\]>/);
  if(cdata) return cleanText(cdata[1]);
  return cleanText(element.textContent || element.innerText || '');
}
function findElement(parent, ...selectors){
  for(const sel of selectors){
    const el = parent.querySelector(sel) || parent.getElementsByTagName(sel)[0] || parent.getElementsByTagName(sel.replace(/^.*:/,''))[0];
    if(el) return el;
  }
  return null;
}
function getLink(item){
  let link = item.querySelector('link[href]');
  if(link) return link.getAttribute('href');
  link = item.querySelector('link[rel="alternate"]');
  if(link) return link.getAttribute('href');
  link = item.querySelector('link');
  if(link){
    const href = link.getAttribute('href');
    if(href) return href;
    const text = getText(link);
    if(text && text.match(/^https?:\/\//)) return text;
  }
  const guid = item.querySelector('guid');
  if(guid){
    const txt = getText(guid);
    if(txt && txt.match(/^https?:\/\//)) return txt;
  }
  return null;
}
function parseItems(doc){
  const items = [];
  const elements = [
    ...doc.querySelectorAll('item'),
    ...doc.querySelectorAll('entry'),
    ...doc.getElementsByTagName('item'),
    ...doc.getElementsByTagName('entry')
  ];
  const unique = [...new Set(elements)];
  for(const item of unique){
    const titleEl = findElement(item,'title');
    const title = titleEl ? getText(titleEl) : null;
    const link = getLink(item);
    const dateEl = findElement(item,'pubDate','published','updated','dc:date','date');
    const pubDate = dateEl ? getText(dateEl) : null;
    if(title && link) items.push({ title, link, pubDate });
  }
  return items;
}

/* Muestra artículos */
function safeAttr(s){
  return String(s).replace(/"/g,'&quot;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}
function displayItems(items, container, header, section){
  container.innerHTML = '';
  section.className = section.className.replace('loading','').trim();
  const count = Math.min(items.length, 5);
  for(let i=0;i<count;i++){
    const { title, link, pubDate } = items[i];
    const div = document.createElement('div');
    div.className = 'feed-item';
    let dateStr = '';
    if(pubDate){
      try{
        const d = new Date(pubDate);
        if(!isNaN(d.getTime())){
          dateStr = `<div class="feed-item-meta">${d.toLocaleString('es-MX',{ year:'numeric', month:'short', day:'numeric', hour:'2-digit', minute:'2-digit'})}</div>`;
        }
      }catch(e){}
    }
    const safeTitle = safeAttr(title);
    const safeLink = safeAttr(link);
    div.innerHTML = `<a href="${safeLink}" target="_blank" rel="noopener noreferrer">${safeTitle}</a>${dateStr}`;
    container.appendChild(div);
  }
  const status = header.querySelector('.feed-status');
  if(status) status.remove();
  updateStatus();
}

/* Carga de feed con proxys y timeouts */
async function loadFeed(name, url){
  const section = document.createElement('section');
  section.className = 'feed-section loading';
  section.id = `feed-${name.replace(/\s+/g,'-').toLowerCase()}`;
  const header = document.createElement('div');
  header.className = 'feed-header';
  header.innerHTML = `<div><h3 class="feed-title">${safeAttr(name)}</h3></div><div><span class="feed-status loading">Cargando...</span></div>`;
  section.appendChild(header);
  const itemsContainer = document.createElement('div');
  itemsContainer.className = 'feed-items';
  createLoadingSkeleton(itemsContainer);
  section.appendChild(itemsContainer);
  document.getElementById('feedsContainer').appendChild(section);

  try{
    const controller = new AbortController();
    const timeoutId = setTimeout(()=>controller.abort(),25000);
    let text = '';
    const proxies = [
      `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(url)}`,
      `https://api.allorigins.win/get?url=${encodeURIComponent(url)}`
    ];
    let lastError = null;
    for(const proxy of proxies){
      try{
        const resp = await fetch(proxy, { signal: controller.signal });
        if(!resp.ok) continue;
        const ct = resp.headers.get('content-type') || '';
        if(proxy.includes('allorigins') && ct.includes('json')){
          const json = await resp.json();
          text = json.contents || '';
        }else{
          text = await resp.text();
        }
        if(text && text.trim().length > 100) break;
      }catch(e){
        lastError = e;
        continue;
      }
    }
    clearTimeout(timeoutId);
    if(!text || text.trim().length < 100) throw lastError || new Error('Feed vacío o inaccesible');
    text = text.trim();
    if(text.charCodeAt(0) === 0xFEFF) text = text.slice(1);
    text = text.replace(/&(?!(?:amp|lt|gt|quot|apos|nbsp|#\d+|#x[0-9a-fA-F]+);)/g,'&amp;');
    const parser = new DOMParser();
    let doc = parser.parseFromString(text,'application/xml');
    if(doc.querySelector('parsererror')) doc = parser.parseFromString(text,'text/html');
    const items = parseItems(doc);
    if(items.length === 0) throw new Error('No se encontraron artículos válidos');
    displayItems(items, itemsContainer, header, section);
    loadedCount++;
  }catch(err){
    console.error(`Error loading ${name}:`, err);
    addDivider();
    document.getElementById('feedsFailed').appendChild(section);
    section.className = 'feed-section error';
    const statusSpan = header.querySelector('.feed-status');
    if(statusSpan){
      statusSpan.className = 'feed-status error';
      statusSpan.textContent = 'Error';
    }
    const errorMsg = err && err.name === 'AbortError' ? 'Tiempo agotado' : (err && err.message ? err.message : 'Error desconocido');
    itemsContainer.innerHTML = `<div class="error-message">${safeAttr(errorMsg)}</div>
      <button class="retry-btn" type="button" onclick="retryFeed('${safeAttr(name)}','${safeAttr(url)}')">Reintentar</button>`;
    errorCount++;
  }finally{
    updateStatus();
  }
}

/* Reintentar feed */
window.retryFeed = async function(name, url){
  // eliminar posible sección previa
  const id = `feed-${String(name).replace(/\s+/g,'-').toLowerCase()}`;
  const prev = document.getElementById(id);
  if(prev) prev.remove();
  if(errorCount > 0) errorCount--;
  if(errorCount === 0 && dividerAdded){
    document.getElementById('dividerContainer').innerHTML = '';
    dividerAdded = false;
  }
  updateStatus();
  // nombre original puede contener entidades; pasar sin alterar
  await loadFeed(name, url);
};

/* Inicialización */
window.addEventListener('load', () => {
  for(const [name,url] of Object.entries(feeds)){
    loadFeed(name, url);
  }
  // actualizar estado inicial
  updateStatus();
});
</script>
</body>
</html>
