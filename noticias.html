<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Agregador de Noticias RSS de México</title>
  <style>
    :root {
      --primary: #000;
      --bg: #fff;
      --border: #ddd;
      --shadow: rgba(0, 0, 0, 0.1);
      --success: #0a0;
      --warning: #fa0;
      --error: #f00;
    }

    * {
      box-sizing: border-box;
    }

    html, body {
      height: 100%;
      margin: 0;
      background: var(--bg);
      color: var(--primary);
      font-family: "Courier New", monospace;
      font-size: 14px;
    }

    .header {
      background: var(--bg);
      border-bottom: 2px solid var(--primary);
      padding: 16px 24px;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .header h1 {
      margin: 0;
      font-size: 20px;
      font-weight: bold;
      text-align: center;
    }

    .status-bar {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      font-size: 11px;
      margin-top: 8px;
      color: #666;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #666;
    }

    .status-dot.loading {
      background: var(--warning);
      animation: pulse 1s infinite;
    }

    .status-dot.loaded {
      background: var(--success);
    }

    .status-dot.error {
      background: var(--error);
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 24px;
    }

    .section-divider {
      margin: 48px 0 32px 0;
      padding: 12px 16px;
      border: 1px solid var(--border);
      border-left: 3px solid var(--error);
      background: #f8f8f8;
    }

    .section-divider h2 {
      margin: 0;
      font-size: 14px;
      font-weight: bold;
      color: #666;
    }

    .section-divider p {
      margin: 4px 0 0 0;
      font-size: 11px;
      color: #999;
    }

    .feed-section {
      margin-bottom: 40px;
      border-left: 3px solid var(--primary);
      padding-left: 16px;
      opacity: 0;
      animation: fadeIn 0.3s ease forwards;
    }

    @keyframes fadeIn {
      to { opacity: 1; }
    }

    .feed-section.error {
      border-left-color: var(--error);
      opacity: 0.6;
    }

    .feed-section.loading {
      border-left-color: var(--warning);
    }

    .feed-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 16px;
    }

    .feed-title {
      font-size: 16px;
      font-weight: bold;
      margin: 0;
    }

    .feed-status {
      font-size: 10px;
      padding: 2px 6px;
      border: 1px solid var(--border);
      background: #f8f8f8;
    }

    .feed-status.loading {
      color: var(--warning);
      border-color: var(--warning);
    }

    .feed-status.error {
      color: var(--error);
      border-color: var(--error);
    }

    .feed-items {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .feed-item {
      border-bottom: 1px solid var(--border);
      padding-bottom: 12px;
      transition: all 0.2s ease;
    }

    .feed-item:last-child {
      border-bottom: none;
    }

    .feed-item:hover {
      padding-left: 8px;
    }

    .feed-item a {
      color: var(--primary);
      text-decoration: none;
      display: block;
      line-height: 1.5;
    }

    .feed-item a:hover {
      color: #0066cc;
    }

    .feed-item-meta {
      font-size: 10px;
      color: #999;
      margin-top: 4px;
    }

    .error-message {
      color: var(--error);
      font-size: 11px;
      margin-top: 8px;
      font-style: italic;
    }

    .loading-skeleton {
      height: 20px;
      background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
      background-size: 200% 100%;
      animation: loading 1.5s infinite;
      margin-bottom: 12px;
    }

    @keyframes loading {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }

    .retry-btn {
      background: var(--primary);
      color: var(--bg);
      border: none;
      padding: 6px 12px;
      font-size: 11px;
      font-family: inherit;
      cursor: pointer;
      margin-top: 8px;
    }

    .retry-btn:hover {
      opacity: 0.8;
    }

    @media (max-width: 768px) {
      .container {
        padding: 16px;
      }

      .header {
        padding: 12px 16px;
      }

      .header h1 {
        font-size: 16px;
      }
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>Noticias de México (RSS)</h1>
    <div class="status-bar">
      <span class="status-dot loading" id="statusDot"></span>
      <span id="statusText">Cargando feeds...</span>
    </div>
  </div>

  <div class="container">
    <div id="feedsContainer"></div>
    <div id="dividerContainer"></div>
    <div id="feedsFailed"></div>
  </div>

  <script>
    const feeds = {
      "La Jornada - Política": "https://www.jornada.com.mx/rss/politica.xml",
      
      "Mexico News Daily": "https://mexiconewsdaily.com/feed/",
      "Excélsior": "https://www.excelsior.com.mx/rss.xml",
      "Reforma": "https://www.reforma.com/rss/portada.xml",
      "Vanguardia": "https://vanguardia.com.mx/rss.xml",
      "El Siglo de Torreón": "https://www.elsiglodetorreon.com.mx/index.xml",
      "SinEmbargo": "https://www.sinembargo.mx/feed/",
      "El Norte": "https://www.elnorte.com/rss/portada.xml",
      "Diario de Yucatán": "https://www.yucatan.com.mx/feed",
      "El Informador": "https://www.informador.mx/rss/mexico.xml",
      "24 Horas": "https://24-horas.mx/feed/"
    };

    let loadedCount = 0;
    let errorCount = 0;
    const totalFeeds = Object.keys(feeds).length;
    let dividerAdded = false;

    function updateStatus() {
      const statusDot = document.getElementById('statusDot');
      const statusText = document.getElementById('statusText');
      
      if (loadedCount + errorCount === totalFeeds) {
        if (errorCount === totalFeeds) {
          statusDot.className = 'status-dot error';
          statusText.textContent = 'Error: No se pudieron cargar los feeds';
        } else if (errorCount > 0) {
          statusDot.className = 'status-dot loaded';
          statusText.textContent = `Cargado: ${loadedCount}/${totalFeeds} feeds (${errorCount} errores)`;
        } else {
          statusDot.className = 'status-dot loaded';
          statusText.textContent = `Cargado: ${totalFeeds} feeds`;
        }
      } else {
        statusText.textContent = `Cargando feeds... ${loadedCount + errorCount}/${totalFeeds}`;
      }
    }

    function addDivider() {
      if (dividerAdded || errorCount === 0) return;
      
      const dividerContainer = document.getElementById('dividerContainer');
      dividerContainer.innerHTML = `
        <div class="section-divider">
          <h2>Feeds con problemas</h2>
          <p>Los siguientes feeds no pudieron cargarse correctamente</p>
        </div>
      `;
      dividerAdded = true;
    }

    function createLoadingSkeleton(container) {
      for (let i = 0; i < 3; i++) {
        const skeleton = document.createElement('div');
        skeleton.className = 'loading-skeleton';
        skeleton.style.width = `${60 + Math.random() * 30}%`;
        container.appendChild(skeleton);
      }
    }

    function decodeHTML(html) {
      const txt = document.createElement('textarea');
      txt.innerHTML = html;
      return txt.value;
    }

    function cleanText(text) {
      if (!text) return '';
      
      // Remove CDATA
      text = text.replace(/<!\[CDATA\[([\s\S]*?)\]\]>/g, '$1');
      
      // Decode HTML entities up to 3 times for nested encoding
      for (let i = 0; i < 3; i++) {
        const decoded = decodeHTML(text);
        if (decoded === text) break;
        text = decoded;
      }
      
      // Remove HTML tags
      text = text.replace(/<[^>]+>/g, ' ');
      
      // Clean whitespace
      text = text.replace(/\s+/g, ' ').trim();
      
      return text;
    }

    function getText(element) {
      if (!element) return '';
      
      // Check for CDATA in innerHTML
      const html = element.innerHTML || '';
      const cdataMatch = html.match(/<!\[CDATA\[([\s\S]*?)\]\]>/);
      if (cdataMatch) {
        return cleanText(cdataMatch[1]);
      }
      
      return cleanText(element.textContent || element.innerText || '');
    }

    function findElement(parent, ...selectors) {
      for (const sel of selectors) {
        const el = parent.querySelector(sel) || 
                   parent.getElementsByTagName(sel)[0] ||
                   parent.getElementsByTagName(sel.replace(/^.*:/, ''))[0];
        if (el) return el;
      }
      return null;
    }

    function getLink(item) {
      // Try link element with href
      let link = item.querySelector('link[href]');
      if (link) return link.getAttribute('href');
      
      // Try link with rel=alternate
      link = item.querySelector('link[rel="alternate"]');
      if (link) return link.getAttribute('href');
      
      // Try any link element
      link = item.querySelector('link');
      if (link) {
        const href = link.getAttribute('href');
        if (href) return href;
        const text = getText(link);
        if (text && text.match(/^https?:\/\//)) return text;
      }
      
      // Try guid
      const guid = item.querySelector('guid');
      if (guid) {
        const text = getText(guid);
        if (text && text.match(/^https?:\/\//)) return text;
      }
      
      return null;
    }

    function parseItems(doc) {
      const items = [];
      
      // Find all possible item elements
      const elements = [
        ...doc.querySelectorAll('item'),
        ...doc.querySelectorAll('entry'),
        ...doc.getElementsByTagName('item'),
        ...doc.getElementsByTagName('entry')
      ];
      
      // Remove duplicates
      const uniqueElements = [...new Set(elements)];
      
      for (const item of uniqueElements) {
        const titleEl = findElement(item, 'title');
        const title = titleEl ? getText(titleEl) : null;
        
        const link = getLink(item);
        
        const dateEl = findElement(item, 'pubDate', 'published', 'updated', 'dc:date', 'date');
        const pubDate = dateEl ? getText(dateEl) : null;
        
        if (title && link) {
          items.push({ title, link, pubDate });
        }
      }
      
      return items;
    }

    async function loadFeed(name, url) {
      const section = document.createElement('section');
      section.className = 'feed-section loading';
      section.id = `feed-${name.replace(/\s+/g, '-').toLowerCase()}`;
      
      const header = document.createElement('div');
      header.className = 'feed-header';
      header.innerHTML = `
        <h2 class="feed-title">${name}</h2>
        <span class="feed-status loading">Cargando...</span>
      `;
      section.appendChild(header);
      
      const itemsContainer = document.createElement('div');
      itemsContainer.className = 'feed-items';
      createLoadingSkeleton(itemsContainer);
      section.appendChild(itemsContainer);
      
      document.getElementById('feedsContainer').appendChild(section);

      try {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 25000);
        
        let text = '';
        const proxies = [
          `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(url)}`,
          `https://api.allorigins.win/get?url=${encodeURIComponent(url)}`,
        ];
        
        let lastError = null;
        for (const proxy of proxies) {
          try {
            const response = await fetch(proxy, { signal: controller.signal });
            
            if (!response.ok) continue;
            
            const contentType = response.headers.get('content-type') || '';
            
            // Handle allorigins JSON wrapper
            if (proxy.includes('allorigins') && contentType.includes('json')) {
              const json = await response.json();
              text = json.contents || '';
            } else {
              text = await response.text();
            }
            
            if (text && text.trim().length > 100) {
              break; // Success
            }
          } catch (e) {
            lastError = e;
            continue;
          }
        }
        
        clearTimeout(timeoutId);
        
        if (!text || text.trim().length < 100) {
          throw lastError || new Error('Feed vacío o inaccesible');
        }
        
        // Aggressive XML cleanup
        text = text.trim();
        
        // Remove BOM
        if (text.charCodeAt(0) === 0xFEFF) {
          text = text.slice(1);
        }
        
        // Fix unescaped ampersands but preserve valid entities
        text = text.replace(/&(?!(?:amp|lt|gt|quot|apos|nbsp|#\d+|#x[0-9a-fA-F]+);)/g, '&amp;');
        
        // Parse as XML first, then HTML as fallback
        const parser = new DOMParser();
        let doc = parser.parseFromString(text, 'application/xml');
        
        if (doc.querySelector('parsererror')) {
          // Try as HTML
          doc = parser.parseFromString(text, 'text/html');
        }
        
        const items = parseItems(doc);
        
        if (items.length === 0) {
          throw new Error('No se encontraron artículos válidos');
        }
        
        displayItems(items, itemsContainer, header, section);
        loadedCount++;
        
      } catch (err) {
        console.error(`Error loading ${name}:`, err);
        
        addDivider();
        document.getElementById('feedsFailed').appendChild(section);
        
        section.className = 'feed-section error';
        
        const statusSpan = header.querySelector('.feed-status');
        statusSpan.className = 'feed-status error';
        statusSpan.textContent = 'Error';
        
        const errorMsg = err.name === 'AbortError' 
          ? 'Tiempo agotado' 
          : (err.message || 'Error desconocido');
        
        itemsContainer.innerHTML = `
          <div class="error-message">
            ${errorMsg}
          </div>
          <button class="retry-btn" onclick="retryFeed('${name.replace(/'/g, "\\'")}', '${url.replace(/'/g, "\\'")}')">
            Reintentar
          </button>
        `;
        
        errorCount++;
      } finally {
        updateStatus();
      }
    }

    function displayItems(items, itemsContainer, header, section) {
      itemsContainer.innerHTML = '';
      section.className = 'feed-section';
      
      const displayCount = Math.min(items.length, 5);
      
      for (let i = 0; i < displayCount; i++) {
        const { title, link, pubDate } = items[i];
        
        const div = document.createElement("div");
        div.className = "feed-item";
        
        let dateStr = '';
        if (pubDate) {
          try {
            const date = new Date(pubDate);
            if (!isNaN(date.getTime())) {
              dateStr = `<div class="feed-item-meta">${date.toLocaleString('es-MX', { 
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
              })}</div>`;
            }
          } catch (e) {}
        }
        
        const safeTitle = title.replace(/</g, '&lt;').replace(/>/g, '&gt;');
        
        div.innerHTML = `
          <a href="${link}" target="_blank" rel="noopener noreferrer">${safeTitle}</a>
          ${dateStr}
        `;
        itemsContainer.appendChild(div);
      }
      
      header.querySelector('.feed-status').remove();
    }

    window.retryFeed = async function(name, url) {
      const section = document.getElementById(`feed-${name.replace(/\s+/g, '-').toLowerCase()}`);
      if (section) section.remove();
      
      if (errorCount > 0) errorCount--;
      
      if (errorCount === 0 && dividerAdded) {
        document.getElementById('dividerContainer').innerHTML = '';
        dividerAdded = false;
      }
      
      updateStatus();
      await loadFeed(name, url);
    };

    window.onload = () => {
      for (const [name, url] of Object.entries(feeds)) {
        loadFeed(name, url);
      }
    };
  </script>
</body>
</html>
